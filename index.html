<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Hangama</title>
    <link rel="stylesheet" href="style.css">
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

    <!-- ==================== Header ==================== -->
    <header>
        <div class="container header-container">
            <a href="#" class="logo">Anime Hangama</a>
            <nav>
                <div class="search-wrapper">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search titles...">
                    <button class="search-icon-btn" id="searchIconBtn"><i class="material-icons">search</i></button>
                </div>
                <button class="theme-toggle-btn" id="themeToggle" title="Toggle Theme"><i class="material-icons">brightness_6</i></button>
            </nav>
        </div>
    </header>

    <main class="container">
        
        <!-- ==================== Ad Space (Top) ==================== -->
        <div class="ad-space" id="ad-space-top">
            <p><script type="text/javascript">
	atOptions = {
		'key' : '0dc39fcf5a51b8f5b9473304925acc62',
		'format' : 'iframe',
		'height' : 90,
		'width' : 728,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/0dc39fcf5a51b8f5b9473304925acc62/invoke.js"></script></p>
        </div>

        <!-- ==================== Anime Grid Section ==================== -->
        <h2 class="section-title">Latest Posts</h2>
        <div id="anime-grid">
            <!-- Loading Spinner will be shown here initially -->
            <div class="grid-loader"></div>
        </div>
        
      
      
      <script async="async" data-cfasync="false" src="//pl27335470.profitableratecpm.com/2530496bd56455006dd04ad7f48ada10/invoke.js"></script>
      <div id="container-2530496bd56455006dd04ad7f48ada10"></div>
      
      
      
        <!-- ==================== Ad Space (Bottom) ==================== -->
        <div class="ad-space" id="ad-space-bottom">
            <p><script type="text/javascript">
	atOptions = {
		'key' : '9a3d6b9a7e39bbdf97996c8f632d7307',
		'format' : 'iframe',
		'height' : 250,
		'width' : 300,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/9a3d6b9a7e39bbdf97996c8f632d7307/invoke.js"></script></p>
        </div>

    </main>

    <!-- ==================== Footer ==================== -->
    <footer>
        <p>© 2025 Anime Hangama. All Rights Reserved.</p>
    </footer>
  
  
  

    <!-- JavaScript File -->
    


<script>
    // नया, बेहतर और सुरक्षित कोड

    document.addEventListener('DOMContentLoaded', () => {

        const animeGrid = document.getElementById('anime-grid');
        const backendBaseUrl = 'https://anime-hangama.onrender.com';

        // यह फंक्शन सर्वर को अपडेट भेजता है (ज़्यादा भरोसेमंद)
        const updateCounter = (postId, type) => {
            if (!postId || !type) return; // अगर ID या टाइप न हो तो कुछ न करें
            const url = `${backendBaseUrl}/api/posts/${type}/${postId}`;
            
            // sendBeacon बैकग्राउंड में रिक्वेस्ट भेजता है, ताकि पेज बदलने पर भी यह काम करे
            if (navigator.sendBeacon) {
                navigator.sendBeacon(url);
            } else {
                // पुराने ब्राउज़र के लिए फॉलबैक
                fetch(url, { method: 'PATCH', keepalive: true }).catch(err => {});
            }
        };

        // यह फंक्शन सर्वर से पोस्ट लाता है
        const loadPosts = async () => {
            animeGrid.innerHTML = '<div><div class="grid-loader"></div><p style="text-align:center; color: var(--text-secondary);">Connecting to server, please wait...</p></div>';

            try {
                const response = await fetch(`${backendBaseUrl}/api/posts`);
                if (!response.ok) throw new Error(`Network response was not ok`);
                
                const posts = await response.json();
                renderPosts(posts);

            } catch (error) {
                console.error('Failed to load posts:', error);
                animeGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">पोस्ट लोड करने में विफल। कृपया बाद में प्रयास करें।</p>';
            }
        };

        // यह फंक्शन पोस्ट्स को स्क्रीन पर दिखाता है
        const renderPosts = (postsToRender) => {
            animeGrid.innerHTML = '';
            if (!postsToRender || postsToRender.length === 0) {
                animeGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">अभी कोई पोस्ट उपलब्ध नहीं है।</p>';
                return;
            }

            postsToRender.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // पोस्ट्स को नए से पुराने क्रम में लगाएं

            postsToRender.forEach(post => {
                const card = document.createElement('div');
                card.className = 'anime-card';

                card.innerHTML = `
                    <div class="card-img-wrapper">
                        <img src="${post.imageUrl}" alt="${post.title}" loading="lazy">
                    </div>
                    <div class="card-content">
                        <h3 class="card-title" title="${post.title}">${post.title}</h3>
                        <div class="card-footer">
                            <span class="view-count">
                                <i class="material-icons" style="font-size: 1rem;">visibility</i>
                                <span id="views-${post._id}">${(post.views || 0).toLocaleString()}</span>
                            </span>
                            <a href="${post.link}" target="_blank" class="card-link" rel="noopener noreferrer">Watch Now</a>
                        </div>
                    </div>
                `;

                const cardLink = card.querySelector('.card-link');

                // जब "Watch Now" बटन पर क्लिक हो
                cardLink.addEventListener('click', (e) => {
                    e.stopPropagation(); // कार्ड के क्लिक को रोकें ताकि व्यू काउंट न हो
                    updateCounter(post._id, 'click');
                });

                // जब पूरे कार्ड पर (बटन को छोड़कर) क्लिक हो
                card.addEventListener('click', (e) => {
                    if (e.target.classList.contains('card-link')) return; // अगर बटन पर क्लिक हुआ है तो कुछ न करें

                    // व्यूज को तुरंत स्क्रीन पर बढ़ाएं ताकि यूजर को दिखे
                    const viewElement = document.getElementById(`views-${post._id}`);
                    if (viewElement) {
                        viewElement.textContent = (parseInt(viewElement.textContent.replace(/,/g, '')) + 1).toLocaleString();
                    }
                    
                    updateCounter(post._id, 'view');
                    window.open(post.link, '_blank');
                });

                animeGrid.appendChild(card);
            });
        };

        // पेज लोड होते ही पोस्ट्स लोड करें
        loadPosts();
    });
</script>
	
	
  
</body>
</html>
